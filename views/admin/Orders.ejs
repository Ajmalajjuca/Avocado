<!DOCTYPE html>
<html lang="en">
    <%- include('partials/head.ejs') %>

<body>
    <%- include('partials/side.ejs') %>
    <main class="main-wrap">
        <%- include('partials/heder.ejs') %>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Order List</h2>
                    <p>Manage all your orders from here.</p>
                </div>
                <div>
                    <input type="text" placeholder="Search order ID" class="form-control bg-white">
                </div>
            </div>
            <div class="card mb-4">
                <header class="card-header">
                    <div class="row gx-3">
                        <div class="col-lg-4 col-md-6 me-auto">
                            <input type="text" placeholder="Search..." class="form-control">
                        </div>
                        <div class="col-lg-2 col-6 col-md-3">
                            <select class="form-select">
                                <option>Status</option>
                                <option>Active</option>
                                <option>Disabled</option>
                                <option>Show all</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-6 col-md-3">
                            <select class="form-select">
                                <option>Show 20</option>
                                <option>Show 30</option>
                                <option>Show 40</option>
                            </select>
                        </div>
                    </div>
                </header>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#ID</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Date</th>
                                    <th scope="col" class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach(order => { %>
                                    <tr>
                                        <td><%= order.orderId %></td>
                                        <td><b><%= order.userId.username %> </b></td>
                                        <td><%= order.userId.email %></td>
                                        <td>â‚¹<%= order.amount %></td>
                                        <td>
                                            <% if (order.status === 'Pending') { %>
                                                <span class="badge rounded-pill alert-warning">Pending</span>
                                            <% } else if (order.status === 'pending') { %>
                                                <span class="badge rounded-pill alert-warning">Pending</span>
                                            <% } else if (order.status === 'Intransit') { %>
                                                <span class="badge rounded-pill alert-primary">In-transit</span>
                                            <% } else if (order.status === 'Canceled') { %>
                                                <span class="badge rounded-pill alert-danger">Canceled</span>
                                            <% } else if (order.status === 'Shipped') { %>
                                                <span class="badge rounded-pill alert-info">Shipped</span>
                                            <% } else if (order.status === 'Delivered') { %>
                                                <span class="badge rounded-pill alert-success">Delivered</span>
                                            <% } else if (order.status === 'Returned') { %>
                                                <span class="badge rounded-pill alert-secondary">Returned</span>
                                            <% } else { %>
                                                <%= order.status %>
                                            <% } %>
                                        </td>
                                        <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                        <td class="text-end">
                                            <a href="javascript:void(0);" class="btn btn-md rounded font-sm" onclick="toggleDetails('<%= order._id %>')">Detail</a>
                                            <div class="dropdown">
                                                <a href="#" data-bs-toggle="dropdown" class="btn btn-light rounded btn-sm font-sm">
                                                    <i class="material-icons md-more_horiz"></i>
                                                </a>
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item" href="/order/<%= order.id %>/update"></a>

                                                    <a class="dropdown-item" href="#" onclick="updateStatus('<%= order._id %>', 'Pending')">Pending</a>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus('<%= order._id %>', 'Intransit')">In-transit</a>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus('<%= order._id %>', 'Canceled')">Canceled</a>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus('<%= order._id %>', 'Shipped')">Shipped</a>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus('<%= order._id %>', 'Delivered')">Delivered</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="details-<%= order._id %>" class="order-details" style="display:none;">
                                        <td colspan="7">
                                            <h4>Order Items</h4>
                                            <ul>
                                                <% order.items.forEach(item => { %>
                                                  <% if (item.productId) { %>
                                                    <li><%= item.productId.name %> - Quantity: <%= item.quantity %></li>
                                                  <% } else { %>
                                                    <li>Product not available - Quantity: <%= item.quantity %></li>
                                                  <% } %>
                                                <% }) %>
                                              </ul>
                                            <% if (order.address) { %>
                                                <p><strong>Address:</strong> <%= order.address.housename %>, <%= order.address.street %>, <%= order.address.city %>, <%= order.address.state %>, <%= order.address.country %>, <%= order.address.pincode %></p>
                                            <% } else { %>
                                                <p><strong>Address:</strong> Not provided</p>
                                            <% } %>
                                            <p><strong>Payment Method:</strong> <%= order.payment %></p>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="pagination" class="pagination-area mt-15 mb-50">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-start">
                        <% if (currentPage > 1) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">
                                    <i class="material-icons md-chevron_left"></i>
                                </a>
                            </li>
                        <% } %>
            
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <% if (i === currentPage) { %>
                                <li class="page-item active">
                                    <a class="page-link" href="#"><%= i %></a>
                                </li>
                            <% } else { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
                                </li>
                            <% } %>
                        <% } %>
            
                        <% if (currentPage < totalPages) { %>
                            <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">
                                    <i class="material-icons md-chevron_right"></i>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            </div>
            
        </section>
    </main>

    <%- include('partials/foot.ejs') %>

    <script>
        function toggleDetails(orderId) {
            const detailsRow = document.getElementById(`details-${orderId}`);
            if (detailsRow.style.display === 'none' || detailsRow.style.display === '') {
                detailsRow.style.display = 'table-row';
            } else {
                detailsRow.style.display = 'none';
            }
        }

        function updateStatus(orderId, status) {
    fetch(`/admin/order/${orderId}/update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Reload the page to reflect the status update
        } else {
            alert(data.message || 'Failed to update order status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating order status');
    });
}
    </script>
</body>
</html>
